# 注文管理システム（OrderHub）— 全体概要

## 目的

OrderHub は、ECの注文を「作成・参照・ステータス更新・出荷連携」するためのシステムです。
**Web管理画面**（CS/オペレーター向け）と **REST API**（外部/社内連携向け）を提供します。

## 想定ユーザーと権限

### ロール

* **OP（オペレーター）**：注文参照、出荷ステータス更新、キャンセル申請
* **ADMIN（管理者）**：全機能（キャンセル確定・返金確定、ロール管理）

### 権限の基本方針

* 注文の**参照**は OP/ADMIN とも可能
* **キャンセル確定・返金確定**は ADMIN のみ可能

## 業務フロー（代表）

### 1. 注文作成（外部EC → API）

1. 外部ECが `POST /v1/orders` を呼び出す
2. OrderHub が注文を `PENDING` で作成
3. 注文作成イベント `order.created` を発行

### 2. 入金確定（決済連携 → API）

1. 決済確定を受けて `PATCH /v1/orders/{orderId}` で `PAID` に更新
2. `order.paid` を発行

### 3. 出荷（倉庫連携/CS → Web/ API）

* Web管理画面：注文詳細から「出荷済みにする」
* API：`PATCH /v1/orders/{orderId}` で `SHIPPED`

### 4. キャンセル（CS → Web）

* OPがキャンセル申請（理由入力）
* ADMINがキャンセル確定（必要なら返金確定）

## Web管理画面（画面一覧）

### 注文一覧画面

* 検索条件：注文ID、顧客ID、ステータス、作成日（From/To）
* 一覧項目：注文ID、顧客ID、合計金額、ステータス、作成日時
* 操作：注文詳細へ遷移、CSVエクスポート（ADMINのみ）

### 注文詳細画面

* 注文ヘッダ（顧客ID、合計金額、ステータス）
* 明細（SKU、数量、単価）
* 操作：

  * ステータス更新（OP/ADMIN：制約あり）
  * キャンセル申請（OP/ADMIN）
  * キャンセル確定・返金確定（ADMINのみ）

## 非機能（抜粋）

* 監査：Web管理画面の重要操作（キャンセル確定/返金確定/出荷更新）は監査ログに記録する
* 可観測性：`Request-Id` を全レイヤーで引き回す
* 冪等性：注文作成は `Idempotency-Key` により重複作成を防ぐ
